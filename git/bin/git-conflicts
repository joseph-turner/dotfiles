#!/usr/local/bin/zsh

autoload colors; colors

while getopts "r" opt; do
  case $opt in
    r)
      rebase=1
      ;;
    \?)
      echo "Invalid option: -$OPTARG"
      return 1
      ;;
    :)
      echo "Option -$OPTARG requires an argument"
      return 1
      ;;
  esac
done
shift $((OPTIND-1))

function git_check() {
  git diff --check && git diff --check --cached
}

while ! git_check; do
  echo "\n$fg[red]Conflicts detected!$reset_color\n"
  read -sk "?Press any key when conflicts are resolved"$'\n'
  echo
done

if [[ `git merge HEAD &> /dev/null` -ne 128 ]]; then
  git add -A
  [[ $rebase = 1 ]] && git rebase --continue || git merge --continue
fi
