#!/bin/zsh

autoload colors; colors
local start

# Removes node_modules folder and reinstalls it
# Return early if there's no package.json
if [[ ! -a "./package.json" ]]; then
  echo "$fg[red]No package.json present$reset_color"
  return 1
fi

usage() {
  echo "usage: bounce [<options>]"
  echo
  echo "    -f            force reinstall node modules"
  echo "    -s            runs start script after successful check/install of modules"
  echo "    -h            display this message"
  echo
}

inst() {
  pm_install
}

reinst() {
  pm_reinstall
}

detect_pm() {
  PM=""
  if [[ -f package.json ]]; then
    pkg_pm=$(grep -Po '"packageManager"\s*:\s*"\K[^"]+' package.json 2>/dev/null || true)
    if [[ -n "$pkg_pm" ]]; then
      case "$pkg_pm" in
        pnpm*) PM=pnpm ;;
        yarn*) PM=yarn ;;
        npm*) PM=npm ;;
        bun*) PM=bun ;;
      esac
    fi
  fi

  if [[ -z "$PM" ]]; then
    if [[ -f pnpm-lock.yaml ]]; then
      PM=pnpm
    elif [[ -f yarn.lock ]]; then
      PM=yarn
    elif [[ -f package-lock.json ]]; then
      PM=npm
    elif [[ -f bun.lockb ]]; then
      PM=bun
    fi
  fi

  if [[ -z "$PM" ]]; then
    if command -v pnpm >/dev/null 2>&1; then
      PM=pnpm
    elif command -v yarn >/dev/null 2>&1; then
      PM=yarn
    elif command -v npm >/dev/null 2>&1; then
      PM=npm
    elif command -v bun >/dev/null 2>&1; then
      PM=bun
    else
      PM=npm
    fi
  fi
}

pm_install() {
  detect_pm
  echo
  echo "Installing modules with $PM..."
  case "$PM" in
    yarn)
      yarn install
      ;;
    pnpm)
      pnpm install
      ;;
    bun)
      bun install
      ;;
    npm)
      if [[ -f package-lock.json ]]; then
        npm ci || npm install
      else
        npm install
      fi
      ;;
    *)
      npm install
      ;;
  esac
}

pm_reinstall() {
  detect_pm
  echo
  echo "Reinstalling modules with $PM..."
  case "$PM" in
    yarn)
      yarn install
      ;;
    pnpm)
      pnpm install
      ;;
    bun)
      bun install
      ;;
    npm)
      if [[ -f package-lock.json ]]; then
        npm ci || npm install
      else
        npm install
      fi
      ;;
    *)
      npm install
      ;;
  esac
}

pm_check() {
  detect_pm
  case "$PM" in
    yarn)
      yarn check --verify-tree &> /dev/null
      ;;
    pnpm)
      pnpm -v &> /dev/null && pnpm install --frozen-lockfile --reporter silent --lockfile-only &> /dev/null
      ;;
    npm)
      npm ci --dry-run &> /dev/null || npm -s ls --depth=0 &> /dev/null
      ;;
    bun)
      false
      ;;
    *)
      false
      ;;
  esac
}

while getopts "fhs" opt; do
  case $opt in
    f)
      reinst
      ;;
    h)
      usage
      return 0
      ;;
    s)
      start="1"
      ;;
    \?)
      echo "$fg[yellow]Invalid option: -$OPTARG $reset_color"
      usage
      return 1
      ;;
    :)
      echo "$fg[yellow]Option -$OPTARG requires an argument$reset_color"
      usage
      return 1
      ;;
  esac
done
shift "$((OPTIND -1))"

if [[ ! -d "./node_modules" ]]; then
  echo "\nNode modules not installed"
  inst
  return 0
fi

# Attempt to cut time by using `yarn check` if available
if echo "$fg[cyan]Checking node modules...$reset_color" && yarn check --verify-tree &> /dev/null; then
    echo "$fg[green]Packages are up to date. Pull to get new changes or keep on keepin' on!$reset_color"
else
    echo
    echo "$fg[cyan]Changes in node modules detected...$reset_color"
    reinst
fi

[[ $start == "1" ]] && yarn dev
